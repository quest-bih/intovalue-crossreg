---
title: "Results manual validation"
format: html
editor: visual
---

# Introduction

# Dataset and packages

```{r message = FALSE, warning = FALSE}

final_data <- read.csv("~/Desktop/Research group Strech/intovalue-crossreg/data/manual_validation_dataset_processed.csv", sep = ",")

library(tidyverse)
library(lubridate)
library(networkD3)
library(highcharter)
```

# Manual validation analysis

## Registry pair count

```{r message = FALSE, warning = FALSE}

final_data |>
  count(registry1, registry2) 
```

## Overall precision

```{r message = FALSE, warning = FALSE}

final_data |>
  count(is_true_crossreg) |>
  mutate(percentage = round(n / sum(n) * 100, 2))
```

## Precision by category

```{r message = FALSE, warning = FALSE}

final_data |>
  group_by(priority) |>
  count(is_true_crossreg) |>
  mutate(percentage = round(n / sum(n) * 100, 2))
```

# Discrepancy analysis

These analyses are going to be conducted in only the pairs that were considered `TRUE` cross-registrations

```{r message = FALSE, warning = FALSE}

discrepancy_data <- final_data |>
  filter(is_true_crossreg == "TRUE")
```

## Summary results - main analysis

Summary results are gonna be analyzed only at the level of both registries having a completed recruitment status.

### **First draft version**

```{r message = FALSE, warning = FALSE}

#filter data
summary_data <- discrepancy_data |>
  filter(overall_recruitment_status_reg1 == "Completed", 
         overall_recruitment_status_reg2 == "Completed") |>
  filter(registry1 == "EUCTR" & registry2 %in% c("ClinicalTrials.gov", "DRKS")) |>
  group_by(registry2) |>
  summarize(
    EUCTR_count = sum(has_summary_results_reg1_main == TRUE, na.rm = TRUE),
    other_registry_count = sum(has_summary_results_reg1_main == FALSE &
                               has_summary_results_reg2_main == TRUE, na.rm = TRUE)) |>
  pivot_longer(cols = c(EUCTR_count, other_registry_count), 
               names_to = "registry_part", values_to = "count") |>
  mutate(registry_part = case_when(
    registry_part == "EUCTR_count" ~ "EUCTR",
    registry_part == "other_registry_count" ~ registry2)) |>
  mutate(registry_part = factor(registry_part, levels = c("EUCTR", 
                                                          "ClinicalTrials.gov", 
                                                          "DRKS")))

#create plot
ggplot() +
  geom_bar(data = summary_data,
           aes(x = registry2, y = count, fill = registry_part),
           stat = "identity", position = position_stack(reverse = TRUE)) +
  geom_text(data = summary_data |> filter(count > 0), 
            aes(x = registry2, y = count, label = count, group = registry_part), 
            position = position_stack(vjust = 0.5, reverse = TRUE), 
            color = "black", size = 4) +
  scale_fill_manual(values = c("EUCTR" = "darkgrey", 
                               "ClinicalTrials.gov" = "lightgrey", 
                               "DRKS" = "lightgrey")) + 
  labs(x = "Registry Combination", y = "Count of Summary Results", fill = "Registry") +
  scale_x_discrete(labels = c("ClinicalTrials.gov" = "EUCTR-ClinicalTrials.gov", 
                              "DRKS" = "EUCTR-DRKS")) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 10)) + 
  theme_classic() +
  theme(legend.position = "top")
```

### **New version**

```{r message = FALSE, warning = FALSE}

#prepare data
summary_data2 <- discrepancy_data |>
  filter(overall_recruitment_status_reg1 == "Completed",
         overall_recruitment_status_reg2 == "Completed") |>
  mutate(result_label = case_when(
    has_summary_results_reg1_main == FALSE & has_summary_results_reg2_main == FALSE ~ "No results",
    has_summary_results_reg1_main == TRUE & has_summary_results_reg2_main == FALSE ~ "Only EUCTR",
    has_summary_results_reg1_main == TRUE & has_summary_results_reg2_main == TRUE ~ "Both",
    has_summary_results_reg1_main == FALSE & has_summary_results_reg2_main == TRUE ~ "Other registry"),
    result_label = factor(result_label, levels = c("Other registry", "Both", "Only EUCTR", "No results"))) |>
  group_by(registry2, result_label) |>
  summarise(count = n()) 

#plot
ggplot(data = summary_data2, aes(x = registry2, y = count, fill = result_label)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = count), position = position_stack(vjust = 0.5), size = 3.5) +
  labs(x = "Registry combination", y = "Count of Summary Results", fill = "Results") +
  scale_fill_manual(values = c("No results" = "lightgrey", 
                               "Only EUCTR" = "#2066a8", 
                               "Both" = "#3594cc", 
                               "Other registry" = "#8cc5e3")) +
  scale_y_continuous(limits = c(0, 200), 
                     breaks = seq(0, 200, by = 20)) +
  scale_x_discrete(labels = c("ClinicalTrials.gov" = "EUCTR-ClinicalTrials.gov", 
                              "DRKS" = "EUCTR-DRKS")) + 
  theme_classic() +
  theme(axis.text = element_text(size = 10),
        legend.position = "top")
```

### **Version with percentages**

```{r message = FALSE, warning = FALSE}

#transform count to percentage
summary_data3 <- discrepancy_data |>
  filter(overall_recruitment_status_reg1 == "Completed",
         overall_recruitment_status_reg2 == "Completed") |>
  mutate(result_label = case_when(
      has_summary_results_reg1_main == FALSE & has_summary_results_reg2_main == FALSE ~ "No results",
      has_summary_results_reg1_main == TRUE & has_summary_results_reg2_main == FALSE ~ "Only EUCTR",
      has_summary_results_reg1_main == TRUE & has_summary_results_reg2_main == TRUE ~ "Both",
      has_summary_results_reg1_main == FALSE & has_summary_results_reg2_main == TRUE ~ "Other registry"),
    result_label = factor(result_label, levels = c("Other registry", "Both", "Only EUCTR", "No results"))) |>
  group_by(registry2, result_label) |>
  summarise(count = n()) |>
  group_by(registry2) |>
  mutate(percent = count / sum(count) * 100) 
  
#plot
ggplot(data = summary_data3, aes(x = registry2, y = percent, fill = result_label)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = paste0(round(percent, 1), "%")), 
            position = position_stack(vjust = 0.5), size = 3.5) +
  labs(x = "Registry combination", y = "Percentage of Summary Results", fill = "Results") +
  scale_fill_manual(values = c("No results" = "lightgray", 
                               "Only EUCTR" = "#2066a8", 
                               "Both" = "#3594cc", 
                               "Other registry" = "#8cc5e3")) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 10)) +
  scale_x_discrete(labels = c("ClinicalTrials.gov" = "EUCTR-ClinicalTrials.gov", 
                              "DRKS" = "EUCTR-DRKS")) +
  theme_classic() +
  theme(axis.text = element_text(size = 10),
        legend.position = "top")
```

Here with percentages the information that is lost is the difference in n between EUCTR-ClinicalTrials.gov and EUCTR-DRKS. One option is to use the count plot, the other is to create these percentage plots separately for each plot:

```{r message = FALSE, warning = FALSE}

#ClinicalTrials.gov
summary_data3 |>
  filter(registry2 == "ClinicalTrials.gov") |>
  mutate(result_label = factor(result_label, levels = result_label[order(-percent)])) |>
  ggplot(aes(x = result_label, y = percent, fill = result_label)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = paste0(round(percent, 1), "%")), 
            position = position_stack(vjust = 0.5), size = 3.5) +
  labs(x = "Summary results status", y = "Percentage") +
  scale_fill_manual(values = c("No results" = "lightgray", 
                               "Only EUCTR" = "#2066a8", 
                               "Both" = "#3594cc", 
                               "Other registry" = "#8cc5e3")) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 10)) +
  theme_classic() +
  theme(axis.text = element_text(size = 10),
        legend.position = "none")

#DRKS
summary_data3 |>
  filter(registry2 == "DRKS") |>
  mutate(result_label = factor(result_label, levels = result_label[order(-percent)])) |>
  ggplot(aes(x = result_label, y = percent, fill = result_label)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = paste0(round(percent, 1), "%")), 
            position = position_stack(vjust = 0.5), size = 3.5) +
  labs(x = "Summary results status", y = "Percentage") +
  scale_fill_manual(values = c("No results" = "lightgray", 
                               "Only EUCTR" = "#2066a8", 
                               "Both" = "#3594cc", 
                               "Other registry" = "#8cc5e3")) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 10)) +
  theme_classic() +
  theme(axis.text = element_text(size = 10),
        legend.position = "none")
```

## Summary results - sensitivity analysis

*To be replicated after **definition** of main analysis*

## Recruitment status

To create the data for the sankey plot, I added a source and target columns with the required values

```{r message = FALSE, warning = FALSE}

#create source column
discrepancy_data <- discrepancy_data |>
  mutate(sankey_source = paste("EUCTR", overall_recruitment_status_reg1))

#create target column
discrepancy_data <- discrepancy_data |>
  mutate(sankey_target = case_when(
    registry2 == "ClinicalTrials.gov" ~ paste("ClinicalTrials.gov", overall_recruitment_status_reg2),
    registry2 == "DRKS" ~ paste("DRKS", overall_recruitment_status_reg2)
  ))

#filter data for sankey plot: 
sankey_data <- discrepancy_data |> 
  count(sankey_source, sankey_target)
```

```{r message = FALSE, warning = FALSE}

#OPTION 1

#node list
nodes <- data.frame(name = unique(c(sankey_data$sankey_source, sankey_data$sankey_target)))

#links
sankey_data$IDsource <- match(sankey_data$sankey_source, nodes$name) - 1
sankey_data$IDtarget <- match(sankey_data$sankey_target, nodes$name) - 1

links <- data.frame(source = sankey_data$IDsource,
                    target = sankey_data$IDtarget,
                    value = sankey_data$n)

#sankey plot
sankeyNetwork(Links = links, Nodes = nodes, 
              Source = "source", Target = "target", 
              Value = "value", NodeID = "name", 
              fontSize = 12, nodeWidth = 30)
```

```{r message = FALSE, warning = FALSE}

#OPTION 2

sankey_data2 <- discrepancy_data |>
  select(registry1, registry2, 
         overall_recruitment_status_reg1, 
         overall_recruitment_status_reg2) |>
  mutate(overall_recruitment_status_reg1 = paste("EUCTR", overall_recruitment_status_reg1),
         overall_recruitment_status_reg2 = ifelse(
           registry2 == "ClinicalTrials.gov",
           paste("ClinicalTrials.gov", overall_recruitment_status_reg2),
           paste("DRKS", overall_recruitment_status_reg2)
    )) |>
  select(-registry1, -registry2)
  
hchart(data_to_sankey(sankey_data2), "sankey", name = "test") |>
  hc_add_theme(hc_theme_economist())
```

**Replicating results with numbers from `discrepancy_data`:**

```{r message = FALSE, warning = FALSE}

discrepancy_data |>
  count(overall_recruitment_status_reg1)

discrepancy_data |>
  filter(registry2 == "ClinicalTrials.gov") |>
  count(overall_recruitment_status_reg2)

discrepancy_data |>
  filter(registry2 == "DRKS") |>
  count(overall_recruitment_status_reg2)
```

```{r message = FALSE, warning = FALSE}

discrepancy_data |>
  group_by(registry2) |>
  count(overall_recruitment_status_reg1, overall_recruitment_status_reg2)
```

## Completion date

### Version with pairs that match in completion date

```{r message = FALSE, warning = FALSE}

#ClinicalTrials.gov plot
discrepancy_data |>
  filter(registry2 == "ClinicalTrials.gov") |>
  filter(!is.na(completion_month_year_reg1) & !is.na(completion_month_year_reg2)) |>
  mutate(completion_month_year_reg1 = as.Date(paste0(completion_month_year_reg1, "-01"),
                                              format = "%Y-%m-%d"),
         completion_month_year_reg2 = as.Date(paste0(completion_month_year_reg2, "-01"),
                                              format = "%Y-%m-%d")) |>
  ggplot(aes(y = trn1, 
             x = completion_month_year_reg1,
             xend = completion_month_year_reg2)) +
  geom_dumbbell(color = "darkgray",  
                size = 1,            
                dot_guide = FALSE,   
                size_x = 3,          
                size_xend = 3,       
                colour_x = "#3594cc",    
                colour_xend = "#8cc5e3") +
  theme_classic() +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +  
  labs(x = "Year of completion",
       y = "Pairs of cross-registered trials") +  
  scale_x_date(date_breaks = "1 year", date_labels = "%Y")

#DRKS plot
discrepancy_data |>
  filter(registry2 == "DRKS") |>
  filter(!is.na(completion_month_year_reg1) & !is.na(completion_month_year_reg2)) |>
  mutate(
    completion_month_year_reg1 = as.Date(paste0(completion_month_year_reg1, "-01"), format = "%Y-%m-%d"),
    completion_month_year_reg2 = as.Date(paste0(completion_month_year_reg2, "-01"), format = "%Y-%m-%d")
  ) |>
  ggplot(aes(y = trn1, 
             x = completion_month_year_reg1,
             xend = completion_month_year_reg2)) +
  geom_dumbbell(color = "darkgray",  
                size = 1,            
                dot_guide = FALSE,   
                size_x = 3,          
                size_xend = 3,       
                colour_x = "#3594cc",    
                colour_xend = "#8cc5e3") +
  theme_classic() +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +  
  labs(x = "Year of completion",
       y = "Pairs of cross-registered trials") +  
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") 
```

**Observations:**

-   Low n makes the graph clear. EUCTR-ClinicalTrials.gov is very overcrowded.

-   It would be nice to figure out a way to make pairs that match have a different color, here they just maintain the color of registry2.

**Another suggestion:** make in the text of the paper a count of how many times the registries matched: EUCTR-ClinicalTrials.gov and EUCTR-DRKS. Then add these figures to analyze only cases were the dates did not match. Also account for NA cases that were excluded from analysis.

### Version with only no-match pairs

```{r message = FALSE, warning = FALSE}

#ClinicalTrials.gov plot
discrepancy_data |>
  filter(registry2 == "ClinicalTrials.gov") |>
  filter(!is.na(completion_month_year_reg1) & !is.na(completion_month_year_reg2)) |>
  filter(completion_month_year_reg1 != completion_month_year_reg2) |>
  mutate(completion_month_year_reg1 = as.Date(paste0(completion_month_year_reg1, "-01"),
                                              format = "%Y-%m-%d"),
         completion_month_year_reg2 = as.Date(paste0(completion_month_year_reg2, "-01"),
                                              format = "%Y-%m-%d")) |>
  ggplot(aes(y = trn1, 
             x = completion_month_year_reg1,
             xend = completion_month_year_reg2)) +
  geom_dumbbell(color = "darkgray",  
                size = 1,            
                dot_guide = FALSE,   
                size_x = 3,          
                size_xend = 3,       
                colour_x = "#3594cc",    
                colour_xend = "#8cc5e3") +
  theme_classic() +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +  
  labs(x = "Year of completion",
       y = "Pairs of cross-registered trials") +  
  scale_x_date(date_breaks = "1 year", date_labels = "%Y")

#DRKS plot
discrepancy_data |>
  filter(registry2 == "DRKS") |>
  filter(!is.na(completion_month_year_reg1) & !is.na(completion_month_year_reg2)) |>
  filter(completion_month_year_reg1 != completion_month_year_reg2) |>
  mutate(
    completion_month_year_reg1 = as.Date(paste0(completion_month_year_reg1, "-01"), format = "%Y-%m-%d"),
    completion_month_year_reg2 = as.Date(paste0(completion_month_year_reg2, "-01"), format = "%Y-%m-%d")
  ) |>
  ggplot(aes(y = trn1, 
             x = completion_month_year_reg1,
             xend = completion_month_year_reg2)) +
  geom_dumbbell(color = "darkgray",  
                size = 1,            
                dot_guide = FALSE,   
                size_x = 3,          
                size_xend = 3,       
                colour_x = "#3594cc",    
                colour_xend = "#8cc5e3") +
  theme_classic() +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +  
  labs(x = "Year of completion",
       y = "Pairs of cross-registered trials") +  
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") 
```

**Organized by difference between `completion_month_year_reg1` and `completion_month_year_reg2` on y-axis:**

```{r message = FALSE, warning = FALSE}

#ClinicalTrials.gov
discrepancy_data |>
  filter(registry2 == "ClinicalTrials.gov") |>
  filter(!is.na(completion_month_year_reg1) & !is.na(completion_month_year_reg2)) |>
  filter(completion_month_year_reg1 != completion_month_year_reg2) |>
  mutate(completion_month_year_reg1 = as.Date(paste0(completion_month_year_reg1, "-01"),
                                              format = "%Y-%m-%d"),
         completion_month_year_reg2 = as.Date(paste0(completion_month_year_reg2, "-01"),
                                              format = "%Y-%m-%d"),
         time_diff = abs(completion_month_year_reg2 - completion_month_year_reg1)) |>
  arrange(time_diff) |>
  mutate(trn1 = factor(trn1, levels = trn1)) |>
  ggplot(aes(y = trn1, 
             x = completion_month_year_reg1,
             xend = completion_month_year_reg2)) +
  geom_dumbbell(color = "darkgray",  
                size = 1,            
                dot_guide = FALSE,   
                size_x = 3,          
                size_xend = 3,       
                colour_x = "#3594cc",     
                colour_xend = "#8cc5e3") + 
  theme_classic() +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        legend.position = "top") +  
  labs(x = "Year of completion",
       y = "Pairs of cross-registered trials") +  
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") + #adding labels
  geom_point(aes(x = as.Date(NA), y = NA, color = "EUCTR"), size = 3) +
  geom_point(aes(x = as.Date(NA), y = NA, color = "ClinicalTrials.gov"), size = 3) +
  scale_color_manual(name = "Registry",
                     values = c("EUCTR" = "#3594cc", 
                                "ClinicalTrials.gov" = "#8cc5e3")) +
  guides(color = guide_legend(override.aes = list(size = 3)))

#DRKS
discrepancy_data |>
  filter(registry2 == "DRKS") |>
  filter(!is.na(completion_month_year_reg1) & !is.na(completion_month_year_reg2)) |>
  filter(completion_month_year_reg1 != completion_month_year_reg2) |>
  mutate(completion_month_year_reg1 = as.Date(paste0(completion_month_year_reg1, "-01"),
                                              format = "%Y-%m-%d"),
         completion_month_year_reg2 = as.Date(paste0(completion_month_year_reg2, "-01"),
                                              format = "%Y-%m-%d"),
         time_diff = abs(completion_month_year_reg2 - completion_month_year_reg1)) |>
  arrange(time_diff) |>
  mutate(trn1 = factor(trn1, levels = trn1)) |>
  ggplot(aes(y = trn1, 
             x = completion_month_year_reg1,
             xend = completion_month_year_reg2)) +
  geom_dumbbell(color = "darkgray",  
                size = 1,            
                dot_guide = FALSE,   
                size_x = 3,          
                size_xend = 3,       
                colour_x = "#3594cc",     
                colour_xend = "#8cc5e3") + 
  theme_classic() +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        legend.position = "top") +  
  labs(x = "Year of completion",
       y = "Pairs of cross-registered trials") +  
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") + #adding labels
  geom_point(aes(x = as.Date(NA), y = NA, color = "EUCTR"), size = 3) +
  geom_point(aes(x = as.Date(NA), y = NA, color = "DRKS"), size = 3) +
  scale_color_manual(name = "Registry",
                     values = c("EUCTR" = "#3594cc", 
                                "DRKS" = "#8cc5e3")) +
  guides(color = guide_legend(override.aes = list(size = 3)))
```

**Example paragraph:**

Out of the 233 true cross-registered pairs of TRN, 94 matched in completion date with same year and month (ClinicalTrials.gov = 86; DRKS = 8), 115 did not match on completion date (ClinicalTrials.gov = 109; DRKS = 6), and 24 pairs were not compared due to missing information of completion date (*these 24 are only from EUCTR*; ClinicalTrials.gov =23; DRKS = 1). Figure X. shows the difference in completion date within the 115 pairs that did not match.

```{r message = FALSE, warning = FALSE}

discrepancy_data |>
  filter(registry2 == "ClinicalTrials.gov") |>
  count(completion_month_year_reg1 == completion_month_year_reg2)

discrepancy_data |>
  filter(registry2 == "DRKS") |>
  count(completion_month_year_reg1 == completion_month_year_reg2)
```
